generator client {
  provider = "prisma-client-js"
  output   = "../../node_modules/@prisma/db-chat"
}

datasource db {
  provider = "postgresql"
  url      = env("CHAT_DATABASE_URL")
}

enum ChatType {
  channel
  direct
}

model Conversation {
  id String @id @default(uuid())

  type      ChatType
  channelId String?  @map("channel_id")

  messages     Message[]
  participants ConversationParticipant[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("conversations")
}

model ConversationParticipant {
  conversationId String       @map("conversation_id")
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  userId     String    @map("user_id")
  lastReadAt DateTime? @map("last_read_at")

  @@id([conversationId, userId])
  @@index([userId])
  @@map("conversation_participants")
}

model Message {
  id String @id @default(uuid())

  content String? @db.Text
  fileUrl String? @map("file_url") @db.Text
  deleted Boolean @default(false)

  senderId       String       @map("sender_id")
  conversationId String       @map("conversation_id")
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@index([senderId])
  @@index([conversationId])
  @@index([createdAt])
  @@map("messages")
}
